<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Contraction Tracker</title>
    <meta name="theme-color" content="#dcfce7" />
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
    <script src="https://cdn.jsdelivr.net/npm/tailwindcss-animate@1.0.7/dist/index.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ["Inter", "ui-sans-serif", "system-ui", "-apple-system", "Segoe UI", "Roboto", "Helvetica Neue", "Arial", "Noto Sans", "sans-serif"],
                    },
                    colors: {
                        calm: {
                            50: '#f0fdf4',
                            100: '#dcfce7',
                            200: '#bbf7d0',
                            300: '#86efac',
                            400: '#4ade80',
                            500: '#22c55e',
                            600: '#16a34a',
                            700: '#15803d',
                            800: '#166534',
                            900: '#14532d'
                        }
                    },
                    boxShadow: {
                        soft: '0 10px 30px rgba(2, 6, 23, 0.08)'
                    }
                }
            }
        }
    </script>
    <style>
        html,
        body {
            height: 100%;
        }

        .glass {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.7);
        }
    </style>
</head>

<body class="min-h-screen bg-gradient-to-b from-calm-50 to-white text-slate-800">
    <div class="absolute inset-0 -z-10 pointer-events-none select-none" aria-hidden="true">
        <svg class="absolute -top-24 -right-24 opacity-20" width="420" height="420" viewBox="0 0 200 200"
            xmlns="http://www.w3.org/2000/svg">
            <path fill="#bbf7d0"
                d="M55.3,-61.3C71.7,-54.6,85.2,-36.6,90.4,-16.3C95.7,4,92.7,26.6,80.9,42.1C69,57.5,48.4,65.7,29.1,71.7C9.8,77.7,-8.2,81.5,-24.3,76C-40.5,70.5,-54.8,55.6,-63.1,38.6C-71.3,21.6,-73.6,2.5,-69.7,-15.3C-65.8,-33.1,-55.6,-49.6,-41.3,-56.8C-27,-63.9,-9.5,-61.7,8.8,-71.8C27.1,-81.9,54.6,-104.1,55.3,-61.3Z"
                transform="translate(100 100)" />
        </svg>
        <svg class="absolute -bottom-24 -left-24 opacity-20" width="500" height="500" viewBox="0 0 200 200"
            xmlns="http://www.w3.org/2000/svg">
            <path fill="#a7f3d0"
                d="M44.9,-52.6C59.6,-44.2,73.7,-29.6,79.4,-11.2C85,7.3,82.2,29.5,71.9,47C61.5,64.6,43.5,77.4,23.8,83.4C4.1,89.4,-16.4,88.6,-34.3,80.6C-52.2,72.6,-67.5,57.3,-76,39.3C-84.5,21.3,-86.2,0.6,-80.7,-17.5C-75.1,-35.6,-62.2,-51.1,-47.2,-59.8C-32.1,-68.5,-16,-70.4,0.5,-71C17,-71.6,34,-70.9,44.9,-52.6Z"
                transform="translate(100 100)" />
        </svg>
    </div>

    <main class="mx-auto max-w-3xl px-4 pb-28 pt-8 sm:pt-10">
        <header class="flex items-center justify-between mb-6">
            <h1 class="text-2xl font-semibold tracking-tight">Contraction Tracker</h1>
            <div class="text-xs text-slate-500">All data saved locally</div>
        </header>

        <section class="glass rounded-2xl shadow-soft p-4 sm:p-6 mb-6">
            <div class="flex flex-col items-center gap-4">
                <div id="timerDisplay" class="text-5xl font-semibold tabular-nums tracking-tight">00:00</div>
                <button id="toggleBtn"
                    class="w-full sm:w-auto px-8 py-5 rounded-full text-white text-lg font-medium shadow-soft transition-transform active:scale-95 bg-gradient-to-r from-calm-500 to-calm-400 focus:outline-none focus:ring-4 focus:ring-calm-200">
                    Start Contraction
                </button>
                <div class="flex w-full flex-wrap items-center justify-center gap-2 text-sm text-slate-600">
                    <button id="addManualBtn"
                        class="px-3 py-2 rounded-lg bg-white shadow hover:shadow-md transition">Add Manually</button>
                    <button id="undoBtn" class="px-3 py-2 rounded-lg bg-white shadow hover:shadow-md transition">Undo
                        Last</button>
                    <button id="exportBtn"
                        class="px-3 py-2 rounded-lg bg-white shadow hover:shadow-md transition">Export</button>
                    <button id="importBtn"
                        class="px-3 py-2 rounded-lg bg-white shadow hover:shadow-md transition">Import</button>
                    <button id="clearBtn"
                        class="px-3 py-2 rounded-lg bg-white shadow hover:shadow-md transition">Clear</button>
                </div>
            </div>
        </section>

        <section class="grid grid-cols-2 gap-3 sm:grid-cols-4 sm:gap-4 mb-6" id="statsGrid">
            <!-- Stats tiles injected -->
        </section>

        <section class="glass rounded-2xl shadow-soft p-4 sm:p-6 mb-6">
            <h2 class="text-lg font-semibold mb-4">Charts</h2>
            <div class="grid gap-6">
                <div class="h-56 sm:h-64">
                    <canvas id="durationChart" aria-label="Contraction Duration Chart" role="img"></canvas>
                </div>
                <div class="h-56 sm:h-64">
                    <canvas id="intervalChart" aria-label="Contraction Interval Chart" role="img"></canvas>
                </div>
            </div>
        </section>

        <section class="glass rounded-2xl shadow-soft p-4 sm:p-6">
            <div class="flex items-center justify-between mb-3">
                <h2 class="text-lg font-semibold">Contractions</h2>
                <div class="text-xs text-slate-500">Tap a row to edit</div>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full border-separate border-spacing-y-2">
                    <thead>
                        <tr class="text-left text-xs uppercase text-slate-500">
                            <th class="px-3">#</th>
                            <th class="px-3">Start</th>
                            <th class="px-3">End</th>
                            <th class="px-3">Duration</th>
                            <th class="px-3">Since Prev</th>
                            <th class="px-3">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </section>

        <footer class="mt-6 text-center text-xs text-slate-500">
            This tool is for tracking only and not medical advice. If concerned, contact your healthcare provider.
        </footer>
    </main>

    <!-- Modal -->
    <div id="modal" class="fixed inset-0 hidden items-end sm:items-center justify-center z-50">
        <div class="absolute inset-0 bg-black/40" id="modalBackdrop"></div>
        <div class="relative w-full sm:max-w-md sm:rounded-2xl sm:shadow-soft sm:glass bg-white px-4 py-5 sm:p-6">
            <h3 id="modalTitle" class="text-lg font-semibold mb-4">Add / Edit Contraction</h3>
            <form id="modalForm" class="space-y-3">
                <div>
                    <label class="block text-sm text-slate-600 mb-1" for="startInput">Start</label>
                    <input id="startInput" type="datetime-local"
                        class="w-full rounded-lg border border-slate-300 px-3 py-2 focus:outline-none focus:ring-4 focus:ring-calm-200"
                        required />
                </div>
                <div>
                    <label class="block text-sm text-slate-600 mb-1" for="endInput">End</label>
                    <input id="endInput" type="datetime-local"
                        class="w-full rounded-lg border border-slate-300 px-3 py-2 focus:outline-none focus:ring-4 focus:ring-calm-200"
                        required />
                </div>
                <div class="flex gap-2 pt-2">
                    <button type="submit"
                        class="flex-1 rounded-lg bg-calm-500 text-white px-4 py-2 font-medium shadow-soft">Save</button>
                    <button type="button" id="cancelModalBtn"
                        class="flex-1 rounded-lg bg-white border border-slate-300 px-4 py-2 font-medium">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <input id="fileInput" type="file" accept="application/json" class="hidden" />

    <script>
            (() => {
                const lsKey = 'contractions-v1';
                const $ = (sel) => document.querySelector(sel);
                const $$ = (sel) => Array.from(document.querySelectorAll(sel));

                let contractions = load();
                let timer = null;
                let timingStart = null;

                // Elements
                const timerDisplay = $('#timerDisplay');
                const toggleBtn = $('#toggleBtn');
                const addManualBtn = $('#addManualBtn');
                const undoBtn = $('#undoBtn');
                const exportBtn = $('#exportBtn');
                const importBtn = $('#importBtn');
                const clearBtn = $('#clearBtn');
                const statsGrid = $('#statsGrid');
                const tableBody = $('#tableBody');
                const fileInput = $('#fileInput');

                const modal = $('#modal');
                const modalTitle = $('#modalTitle');
                const modalForm = $('#modalForm');
                const startInput = $('#startInput');
                const endInput = $('#endInput');
                const cancelModalBtn = $('#cancelModalBtn');
                const modalBackdrop = $('#modalBackdrop');

                let editId = null; // id being edited

                // Charts
                let durationChart = null;
                let intervalChart = null;

                // Utils
                function load() {
                    try {
                        const raw = localStorage.getItem(lsKey);
                        if (!raw) return [];
                        const arr = JSON.parse(raw);
                        return Array.isArray(arr) ? arr.filter(v => Number.isFinite(v.start) && Number.isFinite(v.end)) : [];
                    } catch { return []; }
                }
                function persist() {
                    localStorage.setItem(lsKey, JSON.stringify(contractions));
                }
                function uid() { return Math.random().toString(36).slice(2) + Date.now().toString(36); }
                function fmtTime(ts) {
                    const d = new Date(ts);
                    const opts = { hour: '2-digit', minute: '2-digit' };
                    return d.toLocaleDateString(undefined, { month: 'short', day: 'numeric' }) + ' ' + d.toLocaleTimeString(undefined, opts);
                }
                function fmtShort(ts) {
                    const d = new Date(ts);
                    return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                }
                function fmtDur(ms) {
                    const s = Math.max(0, Math.round(ms / 1000));
                    const m = Math.floor(s / 60);
                    const r = s % 60;
                    return `${m}:${r.toString().padStart(2, '0')} min`;
                }
                function fmtPlain(ms) {
                    const s = Math.max(0, Math.round(ms / 1000));
                    const m = Math.floor(s / 60);
                    const r = s % 60;
                    return `${m}:${r.toString().padStart(2, '0')}`;
                }
                function nowMs() { return Date.now(); }

                function sortByStart(a, b) { return a.start - b.start; }

                function calcDerived() {
                    const sorted = [...contractions].sort(sortByStart);
                    let prevStart = null;
                    return sorted.map((c, idx) => {
                        const duration = c.end - c.start;
                        const sincePrev = prevStart == null ? null : (c.start - prevStart);
                        prevStart = c.start;
                        return { ...c, index: idx + 1, duration, sincePrev };
                    });
                }

                function stats() {
                    const rows = calcDerived();
                    if (!rows.length) return {
                        count: 0, lastDur: 0, avgDur: 0, medianDur: 0,
                        lastInterval: 0, avgInterval: 0, last5AvgDur: 0, last5AvgInterval: 0
                    };
                    const durs = rows.map(r => r.duration);
                    const intervals = rows.map(r => r.sincePrev).filter(v => v != null);
                    const lastDur = durs.at(-1) || 0;
                    const lastInterval = intervals.at(-1) || 0;
                    const avg = arr => arr.length ? arr.reduce((a, b) => a + b, 0) / arr.length : 0;
                    const med = arr => {
                        if (!arr.length) return 0;
                        const m = [...arr].sort((a, b) => a - b);
                        const mid = Math.floor(m.length / 2);
                        return m.length % 2 ? m[mid] : (m[mid - 1] + m[mid]) / 2;
                    }
                    const last5AvgDur = avg(durs.slice(-5));
                    const last5AvgInterval = avg(intervals.slice(-5));
                    return {
                        count: rows.length,
                        lastDur,
                        avgDur: avg(durs),
                        medianDur: med(durs),
                        lastInterval,
                        avgInterval: avg(intervals),
                        last5AvgDur,
                        last5AvgInterval,
                    };
                }

                function updateTimerDisplay(ms) {
                    timerDisplay.textContent = fmtPlain(ms);
                }

                function startTiming() {
                    if (navigator.vibrate) navigator.vibrate(30);
                    timingStart = nowMs();
                    toggleBtn.textContent = 'Stop';
                    toggleBtn.classList.remove('from-calm-500', 'to-calm-400');
                    toggleBtn.classList.add('from-red-500', 'to-rose-400');
                    if (timer) clearInterval(timer);
                    timer = setInterval(() => {
                        updateTimerDisplay(nowMs() - timingStart);
                    }, 200);
                }

                function stopTiming() {
                    if (!timingStart) return;
                    if (navigator.vibrate) navigator.vibrate([20, 50, 20]);
                    const end = nowMs();
                    contractions.push({ id: uid(), start: timingStart, end });
                    persist();
                    timingStart = null;
                    clearInterval(timer); timer = null;
                    toggleBtn.textContent = 'Start Contraction';
                    toggleBtn.classList.remove('from-red-500', 'to-rose-400');
                    toggleBtn.classList.add('from-calm-500', 'to-calm-400');
                    updateTimerDisplay(0);
                    render();
                }

                function openModal({ id = null, start = null, end = null } = {}) {
                    editId = id;
                    modalTitle.textContent = id ? 'Edit Contraction' : 'Add Contraction';
                    const toLocal = (ts) => new Date(ts).toISOString().slice(0, 16);
                    const defEnd = end ?? nowMs();
                    const defStart = start ?? (defEnd - 60_000);
                    startInput.value = toLocal(defStart);
                    endInput.value = toLocal(defEnd);
                    modal.classList.remove('hidden');
                    modal.classList.add('flex');
                }
                function closeModal() {
                    editId = null;
                    modal.classList.add('hidden');
                    modal.classList.remove('flex');
                }

                function addOrUpdateFromModal(e) {
                    e.preventDefault();
                    const s = new Date(startInput.value).getTime();
                    const en = new Date(endInput.value).getTime();
                    if (!Number.isFinite(s) || !Number.isFinite(en) || en <= s) {
                        alert('End must be after start.');
                        return;
                    }
                    if (editId) {
                        const idx = contractions.findIndex(c => c.id === editId);
                        if (idx >= 0) {
                            contractions[idx].start = s;
                            contractions[idx].end = en;
                        }
                    } else {
                        contractions.push({ id: uid(), start: s, end: en });
                    }
                    persist();
                    closeModal();
                    render();
                }

                function removeById(id) {
                    contractions = contractions.filter(c => c.id !== id);
                    persist();
                    render();
                }

                function undoLast() {
                    if (!contractions.length) return;
                    contractions.pop();
                    persist();
                    render();
                }

                function exportData() {
                    const data = JSON.stringify(contractions, null, 2);
                    // Copy to clipboard
                    if (navigator.clipboard) navigator.clipboard.writeText(data).catch(() => { });
                    // Download
                    const blob = new Blob([data], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url; a.download = `contractions-${new Date().toISOString().slice(0, 19)}.json`;
                    document.body.appendChild(a); a.click(); a.remove();
                    URL.revokeObjectURL(url);
                }

                function importDataFromFile(file) {
                    const reader = new FileReader();
                    reader.onload = () => {
                        try {
                            const arr = JSON.parse(reader.result);
                            if (!Array.isArray(arr)) throw new Error('Invalid file');
                            contractions = arr.filter(v => Number.isFinite(v.start) && Number.isFinite(v.end)).map(v => ({ id: v.id || uid(), start: v.start, end: v.end }));
                            persist();
                            render();
                        } catch (err) {
                            alert('Could not import file.');
                        }
                    };
                    reader.readAsText(file);
                }

                function clearAll() {
                    if (!confirm('Delete all entries?')) return;
                    contractions = [];
                    persist();
                    render();
                }

                function renderStats() {
                    const s = stats();
                    const tiles = [
                        { label: 'Total', value: s.count },
                        { label: 'Last Duration', value: s.lastDur ? fmtDur(s.lastDur) : '-' },
                        { label: 'Avg Duration', value: s.avgDur ? fmtDur(s.avgDur) : '-' },
                        { label: 'Median Duration', value: s.medianDur ? fmtDur(s.medianDur) : '-' },
                        { label: 'Last Interval', value: s.lastInterval ? fmtDur(s.lastInterval) : '-' },
                        { label: 'Avg Interval', value: s.avgInterval ? fmtDur(s.avgInterval) : '-' },
                        { label: 'Last 5 Avg Dur', value: s.last5AvgDur ? fmtDur(s.last5AvgDur) : '-' },
                        { label: 'Last 5 Avg Int', value: s.last5AvgInterval ? fmtDur(s.last5AvgInterval) : '-' },
                    ];
                    statsGrid.innerHTML = tiles.map(t => `
        <div class="glass rounded-xl p-3 sm:p-4 shadow-soft">
          <div class="text-xs text-slate-500">${t.label}</div>
          <div class="text-lg font-semibold tabular-nums">${t.value}</div>
        </div>
      `).join('');
                }

                function renderTable() {
                    const rows = calcDerived();
                    if (!rows.length) {
                        tableBody.innerHTML = `<tr><td colspan="6" class="px-3 py-6 text-center text-slate-500">No contractions yet.</td></tr>`;
                        return;
                    }
                    tableBody.innerHTML = rows.map((r, idx) => `
        <tr class="bg-white hover:bg-slate-50 cursor-pointer" data-id="${r.id}">
          <td class="px-3 py-2 text-sm text-slate-500">${idx + 1}</td>
          <td class="px-3 py-2 text-sm">${fmtTime(r.start)}</td>
          <td class="px-3 py-2 text-sm">${fmtTime(r.end)}</td>
          <td class="px-3 py-2 text-sm tabular-nums">${fmtDur(r.duration)}</td>
          <td class="px-3 py-2 text-sm tabular-nums">${r.sincePrev == null ? '-' : fmtDur(r.sincePrev)}</td>
          <td class="px-3 py-2 text-sm">
            <button data-action="edit" class="mr-2 px-2 py-1 rounded-md border border-slate-300 bg-white hover:bg-slate-100">Edit</button>
            <button data-action="delete" class="px-2 py-1 rounded-md bg-red-50 text-red-600 border border-red-200 hover:bg-red-100">Delete</button>
          </td>
        </tr>
      `).join('');

                    // Row interactions
                    $$('#tableBody tr').forEach(tr => {
                        const id = tr.getAttribute('data-id');
                        tr.addEventListener('click', (e) => {
                            const action = e.target.getAttribute('data-action');
                            if (action === 'edit') {
                                const item = contractions.find(c => c.id === id);
                                if (item) openModal({ id, start: item.start, end: item.end });
                            } else if (action === 'delete') {
                                e.stopPropagation();
                                if (confirm('Delete this entry?')) removeById(id);
                            } else {
                                const item = contractions.find(c => c.id === id);
                                if (item) openModal({ id, start: item.start, end: item.end });
                            }
                        });
                    });
                }

                function renderCharts() {
                    const rows = calcDerived();
                    const durData = rows.map(r => ({ x: r.start, y: +(r.duration / 1000).toFixed(0) }));
                    const intData = rows.filter(r => r.sincePrev != null).map(r => ({ x: r.start, y: +(r.sincePrev / 1000).toFixed(0) }));

                    const common = {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: { mode: 'nearest', intersect: false },
                        scales: {
                            x: { type: 'time', time: { unit: 'minute' }, grid: { display: false } },
                            y: { beginAtZero: true }
                        },
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    title: (items) => items.length ? new Date(items[0].parsed.x).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '',
                                    label: (item) => `${item.parsed.y} sec`
                                }
                            }
                        }
                    };

                    // Duration chart
                    const durCtx = document.getElementById('durationChart').getContext('2d');
                    if (durationChart) durationChart.destroy();
                    durationChart = new Chart(durCtx, {
                        type: 'line',
                        data: { datasets: [{ label: 'Duration (sec)', data: durData, tension: 0.3, fill: true }] },
                        options: { ...common, scales: { ...common.scales, y: { ...common.scales.y, title: { display: true, text: 'Duration (sec)' } } } }
                    });

                    // Interval chart
                    const intCtx = document.getElementById('intervalChart').getContext('2d');
                    if (intervalChart) intervalChart.destroy();
                    intervalChart = new Chart(intCtx, {
                        type: 'line',
                        data: { datasets: [{ label: 'Interval (sec)', data: intData, tension: 0.3, fill: true }] },
                        options: { ...common, scales: { ...common.scales, y: { ...common.scales.y, title: { display: true, text: 'Interval (sec)' } } } }
                    });
                }

                function render() {
                    renderStats();
                    renderTable();
                    renderCharts();
                }

                // Event bindings
                toggleBtn.addEventListener('click', () => {
                    if (timingStart) { stopTiming(); } else { startTiming(); }
                });

                addManualBtn.addEventListener('click', () => openModal());
                cancelModalBtn.addEventListener('click', closeModal);
                modalBackdrop.addEventListener('click', closeModal);
                modalForm.addEventListener('submit', addOrUpdateFromModal);

                undoBtn.addEventListener('click', undoLast);
                exportBtn.addEventListener('click', exportData);
                importBtn.addEventListener('click', () => fileInput.click());
                fileInput.addEventListener('change', (e) => {
                    const file = e.target.files?.[0];
                    if (file) importDataFromFile(file);
                    fileInput.value = '';
                });
                clearBtn.addEventListener('click', clearAll);

                // Initialize
                updateTimerDisplay(0);
                render();
            })();
    </script>
</body>

</html>